<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/admin_layout :: layout(~{::content}, 'manageBook')}">

<head>
    <title>Manage Books</title>
</head>

<body>
    <div th:fragment="content" class="w-full max-w-7xl mx-auto" th:with="currentPage='manageBook'">

        <!-- Page Header -->
        <div class="mb-10">
            <h1 class="text-4xl font-serif font-bold text-slate-800 mb-2">Manage Books</h1>
            <p class="text-slate-500 text-lg">Add new books to the library inventory or update existing ones.</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-8 w-full">

            <!-- Book Form -->
            <div class="w-full lg:w-1/3 bg-white p-8 rounded-xl shadow-sm border border-gray-100 h-fit">
                <h2 class="text-2xl font-serif font-bold text-slate-800 mb-6 pb-4 border-b border-gray-100"
                    th:text="${isUpdateMode} ? 'Update Book Details' : 'Add New Book'">Add New Book</h2>
                <form th:action="${isUpdateMode} ? @{/admin/update-book} : @{/admin/manage-book}" method="post"
                    th:object="${manageBook}" class="flex flex-col gap-5">
                    <div>
                        <label class="block text-slate-600 text-sm font-bold mb-2 uppercase tracking-wide">ISBN</label>
                        <input type="number" name="isbn"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary shadow-sm transition text-slate-700 bg-slate-50"
                            placeholder="Book ISBN" required th:value="${manageBook.isbn}" />
                    </div>
                    <div>
                        <label class="block text-slate-600 text-sm font-bold mb-2 uppercase tracking-wide">Book
                            Title</label>
                        <input type="text" name="title"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary shadow-sm transition text-slate-700 bg-slate-50"
                            placeholder="Full Title" required th:value="${manageBook.title}" />
                    </div>
                    <div>
                        <label
                            class="block text-slate-600 text-sm font-bold mb-2 uppercase tracking-wide">Author</label>
                        <input type="text" name="author"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary shadow-sm transition text-slate-700 bg-slate-50"
                            placeholder="Author Name" required th:value="${manageBook.author}" />
                    </div>
                    <div>
                        <label class="block text-slate-600 text-sm font-bold mb-2 uppercase tracking-wide">Total
                            Quantity</label>
                        <input type="number" name="totalQuantity"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary shadow-sm transition text-slate-700 bg-slate-50"
                            placeholder="Total Quantity" required th:value="${manageBook.totalQuantity}" />
                    </div>

                    <button type="submit"
                        class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition mt-4 shadow-lg shadow-blue-200 transform active:scale-95 uppercase tracking-wider"
                        th:text="${isUpdateMode} ? 'Update Book' : 'Add Book'">ADD BOOK</button>
                </form>
            </div>

            <!-- Book List -->
            <div class="w-full lg:w-2/3 bg-white p-8 rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <h2 class="text-2xl font-serif font-bold text-slate-800 mb-6">Inventory List</h2>

                <!-- Search Books -->
                <div class="mb-6">
                    <div class="relative w-full">
                        <input type="text" id="bookSearchInput"
                            class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary text-sm"
                            placeholder="Type to search by Title, Author, or ISBN..." th:value="${param.query}">
                        <i class="fa fa-search absolute left-3 top-2.5 text-gray-400"></i>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-lg border border-gray-100">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-800 text-white">
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase">ISBN</th>
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase">Title</th>
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase">Author</th>
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase text-center">Total Quantity
                                </th>
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase text-center">Remaining
                                    Quantity
                                </th>
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody th:fragment="bookTableBody" id="bookTableBody"
                            class="divide-y divide-gray-100 text-slate-600">
                            <tr th:each="book : ${manageBookList}" class="hover:bg-slate-50 transition">
                                <td class="p-4 font-mono text-sm" th:text="${book.isbn}"></td>
                                <td class="p-4 font-medium text-slate-800" th:text="${book.title}"></td>
                                <td class="p-4" th:text="${book.author}"></td>
                                <td class="p-4 text-center font-bold" th:text="${book.totalQuantity}"></td>
                                <td class="p-4 text-center font-mono text-emerald-600 font-bold"
                                    th:text="${book.remainingQuantity}"></td>
                                <td class="p-4 flex gap-3 justify-center">
                                    <form th:action="@{/admin/edit-book/{isbn}(isbn=${book.isbn})}" method="get"
                                        style="display:inline;">
                                        <button type="submit" class="text-emerald-500 hover:text-emerald-700 transition"
                                            title="Edit">
                                            <i class="fa fa-edit text-lg"></i>
                                        </button>
                                    </form>
                                    <form th:action="@{/admin/delete-book/{isbn}(isbn=${book.isbn})}" method="post"
                                        style="display:inline;">
                                        <button type="submit" class="text-red-400 hover:text-red-600 transition"
                                            onclick="return confirm('Are you sure you want to delete this book?')"
                                            title="Delete">
                                            <i class="fa fa-trash text-lg"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            <!-- Empty State -->
                            <tr th:if="${#lists.isEmpty(manageBookList)}">
                                <td colspan="6" class="p-8 text-center text-gray-400 italic">No books in inventory.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const searchInput = document.getElementById('bookSearchInput');
                const tableBody = document.getElementById('bookTableBody');

                if (searchInput) {
                    searchInput.addEventListener('input', function (e) {
                        const query = e.target.value;

                        // Fetch fragment
                        fetch('/admin/books/search-fragment?query=' + encodeURIComponent(query))
                            .then(response => response.text())
                            .then(html => {
                                tableBody.innerHTML = html;
                            })
                            .catch(error => console.error('Error fetching search results:', error));
                    });
                }
            });
        </script>
    </div>
</body>

</html>