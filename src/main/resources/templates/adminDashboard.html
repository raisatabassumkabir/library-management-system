<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/admin_layout :: layout(~{::content}, 'dashboard')}">

<head>
    <title>Admin Dashboard</title>
</head>

<body>
    <div th:fragment="content" class="w-full max-w-7xl mx-auto" th:with="currentPage='dashboard'">
        <!-- Header -->
        <div class="mb-10">
            <h1 class="text-4xl font-serif font-bold text-slate-800 mb-2">Dashboard</h1>
            <p class="text-slate-500 text-lg">Welcome back! Here's an overview of your library.</p>
        </div>

        <!-- Stats Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <!-- Card 1: Total Copies -->
            <div
                class="bg-white rounded-xl p-8 shadow-sm border border-gray-100 flex items-center gap-5 hover:shadow-md transition">
                <div
                    class="w-14 h-14 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center text-2xl">
                    <i class="fa fa-book"></i>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-gray-400 tracking-widest uppercase mb-1">Total Copies</h3>
                    <p class="text-3xl font-serif font-bold text-slate-800" th:text="${totalBookCount}">1247</p>
                </div>
            </div>

            <!-- Card 2: Distinct Titles -->
            <div
                class="bg-white rounded-xl p-8 shadow-sm border border-gray-100 flex items-center gap-5 hover:shadow-md transition">
                <div
                    class="w-14 h-14 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center text-2xl">
                    <i class="fa fa-list-alt"></i>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-gray-400 tracking-widest uppercase mb-1">Distinct Titles</h3>
                    <p class="text-3xl font-serif font-bold text-slate-800" th:text="${uniqueBookCount}">450</p>
                </div>
            </div>

            <!-- Card 3: Issued Books -->
            <div
                class="bg-white rounded-xl p-8 shadow-sm border border-gray-100 flex items-center gap-5 hover:shadow-md transition">
                <div class="w-14 h-14 rounded-lg bg-blue-50 text-primary flex items-center justify-center text-2xl">
                    <i class="fa fa-address-book"></i>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-gray-400 tracking-widest uppercase mb-1">Issued Books</h3>
                    <p class="text-3xl font-serif font-bold text-slate-800" th:text="${totalIssuedBooks}">89</p>
                </div>
            </div>

            <!-- Card 4: Total Members -->
            <div
                class="bg-white rounded-xl p-8 shadow-sm border border-gray-100 flex items-center gap-5 hover:shadow-md transition">
                <div
                    class="w-14 h-14 rounded-lg bg-purple-50 text-purple-600 flex items-center justify-center text-2xl">
                    <i class="fa fa-users"></i>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-gray-400 tracking-widest uppercase mb-1">Total Members</h3>
                    <p class="text-3xl font-serif font-bold text-slate-800" th:text="${userCount}">156</p>
                </div>
            </div>

            <!-- Card 5: Defaulters -->
            <div
                class="bg-white rounded-xl p-8 shadow-sm border border-gray-100 flex items-center gap-5 hover:shadow-md transition">
                <div class="w-14 h-14 rounded-lg bg-red-50 text-red-600 flex items-center justify-center text-2xl">
                    <i class="fa fa-ban"></i>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-gray-400 tracking-widest uppercase mb-1">Defaulters</h3>
                    <p class="text-3xl font-serif font-bold text-slate-800" th:text="${defaulters}">7</p>
                </div>
            </div>
        </div>

        <!-- Total Books Report Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8 mb-12 max-w-5xl mx-auto">
            <h3 class="text-xl font-bold text-slate-800 mb-8">Total Books Report</h3>

            <!-- Top Stats Row -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8 mb-12 text-center">
                <!-- New (Available) -->
                <div>
                    <h4 class="text-3xl font-bold text-emerald-500" id="stat-new">--%</h4>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mt-1">Available</p>
                </div>
                <!-- Issued -->
                <div>
                    <h4 class="text-3xl font-bold text-blue-500" id="stat-issued">--%</h4>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mt-1">Issued</p>
                </div>
                <!-- Lost (Dummy) -->
                <div>
                    <h4 class="text-3xl font-bold text-red-500">0%</h4>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mt-1">Lost</p>
                </div>
                <!-- Returned -->
                <div>
                    <h4 class="text-3xl font-bold text-yellow-500" id="stat-returned">--%</h4>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mt-1">Returned</p>
                </div>
            </div>

            <!-- Chart and Legend Container -->
            <div class="flex flex-col md:flex-row items-center justify-center gap-12 lg:gap-24">
                <!-- Chart Wrapper -->
                <div class="relative w-64 h-64">
                    <canvas id="totalBooksChart"></canvas>
                    <!-- Center Text Overlay -->
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span class="text-slate-800 font-bold text-lg">Weekly Books</span>
                        <span class="text-slate-400 text-xs text-center px-4">Overview</span>
                    </div>
                </div>

                <!-- Custom Legend -->
                <div class="space-y-4 min-w-[150px]">
                    <div class="flex items-center gap-3">
                        <span class="w-3 h-3 rounded-full bg-emerald-400"></span>
                        <span class="text-slate-600 font-medium">Available books</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="w-3 h-3 rounded-full bg-red-400"></span>
                        <span class="text-slate-600 font-medium">Lost books</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                        <span class="text-slate-600 font-medium">Issued books</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="w-3 h-3 rounded-full bg-yellow-400"></span>
                        <span class="text-slate-600 font-medium">Returned books</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart.js CDN -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script th:inline="javascript">
            /*<![CDATA[*/
            document.addEventListener('DOMContentLoaded', function () {
                const totalBooks = /*[[${totalBookCount}]]*/ 0;
                const issuedBooks = /*[[${totalIssuedBooks}]]*/ 0;
                const returnedBooks = /*[[${returnedBooks}]]*/ 0; // Cumulative
                const lostBooks = 0; // Placeholder

                // Logic: "New" = Available
                const availableBooks = totalBooks > issuedBooks ? totalBooks - issuedBooks : 0;

                // For the "Report", we sum these active metrics for the pie chart total
                const totalReportCount = availableBooks + issuedBooks + lostBooks + returnedBooks;

                // Calculate Percentages
                const newPct = totalReportCount > 0 ? Math.round((availableBooks / totalReportCount) * 100) : 0;
                const issuedPct = totalReportCount > 0 ? Math.round((issuedBooks / totalReportCount) * 100) : 0;
                const returnedPct = totalReportCount > 0 ? Math.round((returnedBooks / totalReportCount) * 100) : 0;

                // Update Top Stats
                document.getElementById('stat-new').textContent = newPct + '%';
                document.getElementById('stat-issued').textContent = issuedPct + '%';
                document.getElementById('stat-returned').textContent = returnedPct + '%';

                const ctx = document.getElementById('totalBooksChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Available books', 'Lost books', 'Issued books', 'Returned books'],
                        datasets: [{
                            data: [availableBooks, lostBooks, issuedBooks, returnedBooks],
                            backgroundColor: [
                                '#34d399', // Emerald-400 (New)
                                '#f87171', // Red-400 (Lost)
                                '#3b82f6', // Blue-500 (Issued)
                                '#facc15'  // Yellow-400 (Returned)
                            ],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // Using custom legend
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        let value = context.raw;
                                        // Calculate percentage relative to Total Books (Inventory)
                                        let percentage = totalBooks > 0 ? Math.round((value / totalBooks) * 100) + '%' : '0%';
                                        return label + value + ' (' + percentage + ')';
                                    }
                                }
                            }
                        },
                        cutout: '75%', // Thinner ring
                    }
                });
            });
            /*]]>*/
        </script>
    </div>
</body>

</html>