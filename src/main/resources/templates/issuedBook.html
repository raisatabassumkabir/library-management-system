<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/admin_layout :: layout(~{::content}, 'issuedBook')}">

<head>
    <title>Issued Books</title>
</head>

<body>
    <div th:fragment="content" class="w-full max-w-7xl mx-auto" th:with="currentPage='issuedBook'">

        <!-- Page Header -->
        <div class="mb-10">
            <h1 class="text-4xl font-serif font-bold text-slate-800 mb-2">Issued Books</h1>
            <p class="text-slate-500 text-lg">Manage book issuance and track returned items.</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-8 w-full">

            <!-- Issue Book Form -->
            <div class="w-full lg:w-1/3 bg-white p-8 rounded-xl shadow-sm border border-gray-100 h-fit">
                <h2 class="text-2xl font-serif font-bold text-slate-800 mb-6 pb-4 border-b border-gray-100">Issue a Book
                </h2>
                <form th:action="@{/admin/issued-book}" method="post" th:object="${issuedBook}"
                    class="flex flex-col gap-5">

                    <div>
                        <label
                            class="block text-slate-600 text-sm font-bold mb-2 uppercase tracking-wide">E-mail</label>
                        <input type="email" name="email"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary shadow-sm transition text-slate-700 bg-slate-50"
                            placeholder="Student Email" required />
                    </div>
                    <div>
                        <label class="block text-slate-600 text-sm font-bold mb-2 uppercase tracking-wide">ISBN</label>
                        <input id="isbnInput" type="number" name="isbn"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary shadow-sm transition text-slate-700 bg-slate-50"
                            placeholder="Book ISBN" required />
                    </div>
                    <div>
                        <label class="block text-slate-600 text-sm font-bold mb-2 uppercase tracking-wide">Book
                            Title</label>
                        <input id="titleInput" type="text" name="title"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary shadow-sm transition text-slate-700 bg-slate-50"
                            placeholder="Title of the Book" required />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-slate-600 text-sm font-bold mb-2 uppercase tracking-wide">Issue
                                Date</label>
                            <input type="date" name="issueDate"
                                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary shadow-sm transition text-slate-700 bg-slate-50"
                                required />
                        </div>
                        <div>
                            <label class="block text-slate-600 text-sm font-bold mb-2 uppercase tracking-wide">Return
                                Date</label>
                            <input type="date" name="returnDate"
                                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary shadow-sm transition text-slate-700 bg-slate-50"
                                required />
                        </div>
                    </div>

                    <button type="submit"
                        class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition mt-4 shadow-lg shadow-blue-200 transform active:scale-95">
                        Issue Book
                    </button>

                    <p th:if="${message}" th:text="${message}"
                        class="text-red-500 text-center text-sm font-bold mt-2 bg-red-50 p-2 rounded border border-red-100">
                    </p>
                </form>
            </div>

            <!-- Issued Book List -->
            <div class="w-full lg:w-2/3 bg-white p-8 rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <h2 class="text-2xl font-serif font-bold text-slate-800 mb-6">Issued Books Log</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-100">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-800 text-white shadow-md">
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase">ID</th>
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase">E-mail</th>
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase">ISBN</th>
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase">Book Title</th>
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase whitespace-nowrap">Issue
                                    Date</th>
                                <th class="p-4 font-semibold text-sm tracking-wide uppercase whitespace-nowrap">Return
                                    Date
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 text-slate-600">
                            <tr th:each="book : ${issuedBookList}" class="hover:bg-slate-50 transition">
                                <td class="p-4 font-medium" th:text="${book.id}"></td>
                                <td class="p-4 font-medium" th:text="${book.email}"></td>
                                <td class="p-4 font-mono text-sm" th:text="${book.isbn}"></td>
                                <td class="p-4 text-slate-800 font-semibold" th:text="${book.title}"></td>
                                <td class="p-4 whitespace-nowrap" th:text="${book.issueDate}"></td>
                                <td class="p-4 whitespace-nowrap" th:text="${book.returnDate}"></td>
                            </tr>
                            <!-- Empty State (Optional: if list is empty) -->
                            <tr th:if="${#lists.isEmpty(issuedBookList)}">
                                <td colspan="6" class="p-8 text-center text-gray-400 italic">No books currently issued.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const isbnInput = document.getElementById('isbnInput');
                const titleInput = document.getElementById('titleInput');

                titleInput.addEventListener('focus', function () {
                    const isbn = isbnInput.value;
                    if (isbn) {
                        fetch(`/api/book/${isbn}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.text();
                            })
                            .then(data => {
                                if (data) {
                                    titleInput.value = data;
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching book title:', error);
                            });
                    }
                });
            });
        </script>
    </div>
</body>

</html>